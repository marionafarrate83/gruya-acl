<%- include('../partials/header', { title: 'Visitante Registrado', user: user }) %>
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4 class="text-center">¡Visitante Registrado Exitosamente!</h4>
            </div>
            <div class="card-body text-center">
                <div class="alert alert-success">
                    <h5>ID de Visita: <code><%= visitor.visitId %></code></h5>
                    <p>Nombre: <strong><%= visitor.visitorName %></strong></p>
                    <p>Fecha: <strong><%= visitor.visitDate.toLocaleDateString('es-ES') %> <%= visitor.visitTime %></strong></p>
                </div>
                
                <div class="qr-code mb-4">
                    <img src="<%= qrCodeData %>" alt="Código QR de la visita" class="img-fluid">
                </div>

                <!-- Nuevos botones de PDF -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="d-grid">
                            <a href="/visitors/<%= visitor._id %>/view-pdf" 
                               class="btn btn-outline-primary" target="_blank">
                                <i class="fas fa-eye"></i> Ver PDF
                            </a>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-grid">
                            <a href="/visitors/<%= visitor._id %>/pdf" 
                               class="btn btn-primary">
                                <i class="fas fa-download"></i> Descargar PDF
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Botón para compartir -->
                <div class="mb-4">
                    <button class="btn btn-success" onclick="shareVisit()">
                        <i class="fas fa-share-alt"></i> Compartir Visita
                    </button>
                </div>
                
                <div class="d-flex justify-content-center gap-3 flex-wrap">
                    <a href="/visitors/share/<%= visitor._id %>/whatsapp" 
                       class="btn btn-success whatsapp-btn" target="_blank">
                        <i class="fab fa-whatsapp"></i> Enviar por WhatsApp
                    </a>
                    <a href="/visitors/create" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Nuevo Visitante
                    </a>
                    <a href="/visitors/history" class="btn btn-secondary">
                        <i class="fas fa-history"></i> Ver Historial
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Función para compartir usando Web Share API
async function shareVisit() {
    try {
        // Descargar PDF primero
        const pdfUrl = '/visitors/<%= visitor._id %>/pdf';
        
        // Para compartir, usamos la URL del PDF
        if (navigator.share) {
            await navigator.share({
                title: 'Pase de Visita - <%= visitor.visitorName %>',
                text: 'Te comparto el pase de visita para el condominio. ID: <%= visitor.visitId %>',
                url: window.location.origin + pdfUrl
            });
        } else {
            // Fallback: descargar PDF
            window.location.href = pdfUrl;
        }
    } catch (error) {
        console.log('Error compartiendo:', error);
        // Fallback a descarga
        window.location.href = '/visitors/<%= visitor._id %>/pdf';
    }
}

// Función para compartir específicamente por WhatsApp
function shareWhatsApp() {
    const message = `Te comparto tu pase de visita para el condominio. ID: <%= visitor.visitId %>\n\nPuedes descargar el PDF aquí: ${window.location.origin}/visitors/<%= visitor._id %>/pdf`;
    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
}
</script>

<%- include('../partials/footer') %>