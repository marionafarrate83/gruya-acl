<%- include('../partials/header', { title: 'Escanear Código QR', user: user }) %>
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="text-center">
                        <i class="fas fa-qrcode"></i> Escanear Código QR de Visitante
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body text-center">
                                    <div id="camera-container" class="mb-3">
                                        <video id="qr-video" width="100%" height="300" style="border: 2px solid #007bff; border-radius: 8px;"></video>
                                    </div>
                                    <div id="camera-controls" class="mb-3">
                                        <button id="start-scan" class="btn btn-primary btn-lg">
                                            <i class="fas fa-camera"></i> Iniciar Escaneo
                                        </button>
                                        <button id="stop-scan" class="btn btn-secondary btn-lg" style="display: none;">
                                            <i class="fas fa-stop"></i> Detener Escaneo
                                        </button>
                                    </div>
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i> Apunta la cámara hacia el código QR del visitante
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Resultado del Escaneo</h5>
                                </div>
                                <div class="card-body">
                                    <div id="scan-result" class="text-center">
                                        <div id="no-result" class="alert alert-secondary">
                                            <i class="fas fa-search"></i> Esperando escaneo...
                                        </div>
                                        <div id="valid-result" class="alert alert-success" style="display: none;">
                                            <i class="fas fa-check-circle"></i>
                                            <h5>¡Código Válido!</h5>
                                            <div id="visitor-details"></div>
                                        </div>
                                        <div id="invalid-result" class="alert alert-danger" style="display: none;">
                                            <i class="fas fa-times-circle"></i>
                                            <h5>Código Inválido</h5>
                                            <p id="error-message"></p>
                                        </div>
                                        <div id="loading" class="alert alert-info" style="display: none;">
                                            <i class="fas fa-spinner fa-spin"></i> Verificando código...
                                        </div>
                                    </div>
                                    
                                    <div id="manual-input" class="mt-4">
                                        <h6>O ingresa el código manualmente:</h6>
                                        <div class="input-group">
                                            <input type="text" id="manual-code" class="form-control" placeholder="Ingresa el ID de visita">
                                            <button id="check-manual" class="btn btn-outline-primary">
                                                <i class="fas fa-check"></i> Verificar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Visitantes de Hoy</h5>
                                </div>
                                <div class="card-body">
                                    <div id="today-visitors" class="table-responsive">
                                        <table class="table table-sm table-hover">
                                            <thead>
                                                <tr>
                                                    <th>ID Visita</th>
                                                    <th>Nombre</th>
                                                    <th>Residencia</th>
                                                    <th>Hora</th>
                                                    <th>Estado</th>
                                                </tr>
                                            </thead>
                                            <tbody id="visitors-list">
                                                <!-- Los visitantes se cargarán via JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para detalles del visitante -->
<div class="modal fade" id="visitorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalles del Visitante</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modal-visitor-details">
                <!-- Los detalles se cargarán aquí -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-success" id="mark-visited">
                    <i class="fas fa-check"></i> Marcar como Visitado
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para tomar fotos -->
<div class="modal fade" id="photoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Tomar Fotos del Visitante</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Debe tomar 2 fotos del visitante: una frontal y una del documento de identificación.
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6>Foto Frontal</h6>
                            </div>
                            <div class="card-body text-center">
                                <video id="photo-video" width="100%" height="300" style="display: none;" playsinline autoplay muted></video>
                                <canvas id="photo-canvas" width="400" height="300" style="display: none;"></canvas>
                                <div id="photo-preview-1" class="photo-preview mb-2">
                                    <span class="text-muted">Foto 1 no tomada</span>
                                </div>
                                <button class="btn btn-primary btn-sm" onclick="takePhoto(1)">
                                    <i class="fas fa-camera"></i> Tomar Foto 1
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6>Foto de Identificación</h6>
                            </div>
                            <div class="card-body text-center">
                                <div id="photo-preview-2" class="photo-preview mb-2">
                                    <span class="text-muted">Foto 2 no tomada</span>
                                </div>
                                <button class="btn btn-primary btn-sm" onclick="takePhoto(2)">
                                    <i class="fas fa-camera"></i> Tomar Foto 2
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-3">
                    <button id="upload-photos" class="btn btn-success" disabled>
                        <i class="fas fa-cloud-upload-alt"></i> Subir Fotos
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Por esta otra -->
 <script>var exports = {};</script>
<script src="/js/qr-scanner.umd.min.js"></script>
<script src="/js/qr-scanner-worker.min.js"></script>
<script src="/js/qr-scanner.js"></script>
<script src="/js/photo-capture.js"></script>

<%- include('../partials/footer') %>